<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>とらんざくしょんみるです</title>
		<script src='https://unpkg.com/webcola/WebCola/cola.min.js'></script>
		<script src='https://unpkg.com/cytoscape/dist/cytoscape.min.js'></script>
		<script src='https://unpkg.com/cytoscape-cola@2.2.3/cytoscape-cola.js'></script>
	</head>

	<style>
		body {
			font-family: Arial, Helvetica, sans-serif;
			background-color: rgb(5, 1, 19);
		}
		#cy {
			width: 100%;
			height: 100%;
			position: absolute;
			top: 0px;
			left: 0px;
			z-index: 10;
		}
		#btn-reset {
			border-radius: 50%;
			border: 1px solid rgba(28, 28, 136, 0.9);
			background-color: rgba(28, 28, 136, 0.8);
			color: azure;
			width: 15vw;
			height: 15vw;
			max-width: 100px;
			max-height: 100px;
			min-width: 50px;
			min-height: 50px;
			position: fixed;
			bottom: 30px;
			right: 10px;
			z-index: 100;
		}
		#btn-reset:active{
			border: 1px solid rgba(94, 94, 207, 0.9);
			background-color: rgba(94, 94, 207, 0.8);
			color: azure;
		}
		#used {
			padding: 5px;
			position: fixed;
			bottom: 0px;
			left: 0px;
			width: calc(100vw - 10px);
			background-color: rgba(30, 30, 100, 0.9);
			z-index: 90;
		}
		#used div,
		#used a {
			font-size: 10px;
			color: #fff;
		}
	</style>

	<body>
		<button type='button' id='btn-reset' onclick='draw()'>Reset</button>
		<div id='used'>
			<div>
				used:
				<a href='https://github.com/cytoscape/cytoscape.js' target='_blank' rel='noopener noreferrer'>cytoscape.js</a> /
				<a href='https://github.com/cytoscape/cytoscape.js-cola' target='_blank' rel='noopener noreferrer'>cytoscape-cola.js</a> /
				<a href='https://github.com/tgdwyer/WebCola' target='_blank' rel='noopener noreferrer'>cola.js</a> /
				<a href='https://github.com/tobiaslins/lisk-avatar' target='_blank' rel='noopener noreferrer'>lisk-avatar</a>
			</div>
		</div>
		
		<div id='cy'></div>
		<script>
			const knownAccounts = {
				"lskeqjd8qhzhayd6yykg82xqzvd7fzg74ghxxmnoe": { "owner": "Oliver",          "description": "Lisk" },
				"lsko4uo4fgkv53wvon82697asfy5hojw7yzs9ptjg": { "owner": "Max",             "description": "Lisk" },
				"lsk759gxzh3zp2h9otfmbxc7fp66jpbdyjbr7am8k": { "owner": "Lisk Foundation", "description": "Lisk" },
				"lskfoh99z4p27jj3xz764vczdaj47nkhqamajpxcp": { "owner": "Lisk Foundation", "description": "Lisk" },
				"lskqbhxe6h7ymjkg6h4dq6s88ptm4qh3jke7g4nva": { "owner": "Lisk Foundation", "description": "Lisk" },
				"lsk24cd35u4jdq8szo3pnsqe5dsxwrnazyqqqg5eu": { "owner": "Poloniex",        "description": "Hot Wallet" },
				"lskb428h99jssnq2nqpp6rctwyqfpw4ordozsde9p": { "owner": "Bittrex",         "description": "Hot Wallet" },
				"lskvpm8x6x8vqs5jvff54x392f7vmhfnde92seqo7": { "owner": "Yobit",           "description": "Hot Wallet" },
				"lskq2x2qfrz9gboxmhj2dm82h26re4vgcpycre4ap": { "owner": "BitBay",          "description": "Cold Wallet" },
				"lsktbdkqr8axg3rovndj997dveyrfctrpo95e9byc": { "owner": "BitBay",          "description": "Hot Wallet" },
				"lskfr4ebbwm55r6p97ftz6uae5tapefzfkopyhs98": { "owner": "Changelly",       "description": "Hot Wallet" },
				"lskrvsrdo7m64mh92vvekcv55hk4de93ud4otum8g": { "owner": "HitBTC",          "description": "Hot Wallet" },
				"lsk46tq99u8p7yhukjbg489gjcajxky3zw6wwbgtz": { "owner": "Binance",         "description": "Hot Wallet" },
				"lskmpb6xzeux5tk65qm7ffs5qdtm7cu5b2rmog6tr": { "owner": "Binance",         "description": "Cold Wallet" },
				"lskbwvtd6sp5f5tpvfnu2v3tuvqbwyyfqqeadcawb": { "owner": "Binance",         "description": "Cold Wallet" },
				"lskbmwp8gboxzarq8cu9tm99vn5d4uc5k64adpd6u": { "owner": "Coincheck",       "description": "Hot Wallet" },
				"lskbqdbu354hz87mnc7pddk8ywef33jnuqc5odhbp": { "owner": "Coincheck",       "description": "Cold Wallet" },
				"lskrp589yeykovh47stbf8woj5banujdfsz9oapcf": { "owner": "Coincheck",       "description": "Hot Wallet" },
				"lskutsunurnarjve65ufeon4bu2c2ywhdvrbmxvuv": { "owner": "UPbit",           "description": "Hot Wallet" },
				"lskxqxgkkzdb7uxjqkj9gxtpogsd4kgm4kkb883fj": { "owner": "UPbit",           "description": "Cold Wallet" },
				"lskhysxtgcjjen7tsn8su64y3fs85knymvugw3wyt": { "owner": "Kraken",          "description": "Hot Wallet" },
				"lsk55wjqhqayj99rbmwwodsbaoq4dt4tvf762abds": { "owner": "BitFlyer",        "description": "Cold Wallet" }
			}
			const getTransactions = async(address) => {
				const urlParam = address? `&address=${address}`: '';
			    const response = await fetch(`https://mainnet-service.lisk.com/api/v2/transactions?moduleAssetId=2:0&offset=0&limit=100${urlParam}`);
			    const json = await response.json();
			    if (json.error) return json;
			    return json.data;
			}

			const setCytoscape = (data) => {
				const cy = cytoscape({
					container: document.getElementById('cy'),
					elements: data,
						style: [
							{
								selector: 'node',
								style: {
									'label': 'data(label)',
									'color': '#5caefa',
									'width': 50,
									'height': 50
								}
							},
							{
								selector: 'edge', 
								style: {
									'label': 'data(amount)',
									'color': '#fa5cae',
									'width': 2,
									'target-arrow-shape': 'triangle',
									'line-opacity': 0.7,
									'curve-style': 'straight'
								}
							}
						]
				});
				const layout = cy.layout({
					name: 'cola',
					fit: false,
					padding: 30,
					avoidOverlap: true,
					nodeDimensionsIncludeLabels: true
				});
				layout.run();

				cy.on('tap', 'node', function (evt) {
					draw(evt.target.json().data['id']);
				});

				cy.on('tap', 'edge', function (evt) {
					window.open(`https://liskscan.com/transaction/${evt.target.json().data['id']}`, '_blank');
				});
			}

			const draw = async(address) => {
				const transactions = await getTransactions(address);
				if (transactions.error) {
					alert(transactions.message);
					return;
				}

				const nodes = [];
				const addresses = [];
				const transfers = [];
				for (const tx of transactions) {
					if (!addresses.includes(tx.sender.address)) {
						addresses.push(tx.sender.address);
						const knownAccount = knownAccounts[tx.sender.address];
						let label = tx.sender.username? tx.sender.username: tx.sender.address;
						label = knownAccount? `${knownAccount.owner}(${knownAccount.description})`: label;
						nodes.push({
							data: { id: tx.sender.address, label: label },
							style: { 'background-image': `https://lisk-avatar.ysdev.work/${tx.sender.address}?size=50` }
						});
					}
					if (!addresses.includes(tx.asset.recipient.address)) {
						addresses.push(tx.asset.recipient.address);
						const knownAccount = knownAccounts[tx.asset.recipient.address];
						let label = tx.asset.recipient.username? tx.asset.recipient.username: tx.asset.recipient.address;
						label = knownAccount? `${knownAccount.owner}(${knownAccount.description})`: label;
						nodes.push({
							data: { id: tx.asset.recipient.address, label: label },
							style: { 'background-image': `https://lisk-avatar.ysdev.work/${tx.asset.recipient.address}?size=50` }
						});
					}
					if (!transfers.includes(tx.sender.address + tx.asset.recipient.address) && !transfers.includes(tx.asset.recipient.address + tx.sender.address)) {
						transfers.push(tx.sender.address + tx.asset.recipient.address);
						nodes.push({
							data: { id: tx.id, source: tx.sender.address, target: tx.asset.recipient.address, amount: `${Math.floor(tx.asset.amount/1000000)/100}LSK` },
							style: { 'line-color': `#${tx.id.slice(-6)}`, 'target-arrow-color': `#${tx.id.slice(-6)}` }
						});
					}
				}
				setCytoscape(nodes);
			}

			(async()=> {
				await draw();
			})();
		</script>
	</body>
</html>
